// bin/www
import http from 'node:http';
import dotenv from 'dotenv';
import app from '../app.js';

// Importar funciones de conexi√≥n
import { connectDB } from '../lib/connectMongo.js';
// import { connectMongoose } from '../lib/connectMongoose.js';  // Para m√°s adelante

dotenv.config();

const PORT = process.env.PORT || 3000;
const NODE_ENV = process.env.NODE_ENV || 'development';

const startServer = async () => {
  try {
    console.log('üîÑ Starting application...');
    
    // 1Ô∏è‚É£ Conectar a MongoDB (driver nativo)
    console.log('üîå Connecting to MongoDB...');
    await connectDB();
    
    // 2Ô∏è‚É£ (Opcional) Conectar Mongoose - comentado por ahora
    // console.log('üîå Connecting to Mongoose...');
    // await connectMongoose();
    
    // 3Ô∏è‚É£ Crear servidor
    // 4Ô∏è‚É£ Arrancar servidor

    const server = http.createServer(app);
    server.listen(PORT, () => {
      console.log('\n' + '='.repeat(60));
      console.log(`‚úÖ [${NODE_ENV.toUpperCase()}] Server Ready`);
      console.log(`üöÄ Server running on http://localhost:${PORT}`);
      console.log(`üîó API: http://localhost:${PORT}/api`);
      console.log(`‚ò†Ô∏è  Press CTRL + C to Stop Server`);
      console.log('='.repeat(60) + '\n');
    });

    // Manejo de errores del servidor
    server.on('error', (error) => {
      if (error.code === 'EADDRINUSE') {
        console.error(`‚ùå Port ${PORT} is already in use`);
      } else {
        console.error('‚ùå Server error:', error);
      }
      process.exit(1);
    });

  } catch (error) {
    console.error('\n‚ùå STARTUP ERROR:', error.message);
    console.error('Stack:', error.stack);
    process.exit(1);
  }
};

// Iniciar servidor
startServer();